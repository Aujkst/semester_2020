---
title: "Time Series Analysis"
author: "shake_it"
output:
  
  html_document: default
  word_document: default
  pdf_document:
    includes:
      in_header: header.tex
    keep_tex: yes   
    latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# 第一周

#### 方法

- **描述性时序分析**
- **统计时序分析**（频域分析方法 + 时域分析方法）

#### 生成数据

从2005年1月开始的月度数据。`start`指定起始读入时间，`frequency`指定序列每年读入的数据频率。
```{r }
price <- c(101, 82, 66, 35, 31, 7)

price <- ts(price, start = c(2005, 1), frequency = 12)
```

#### 例1-1

读入1884-1939年英格兰和威尔士小麦平均亩产量数据`file1.csv`
```{r }
x <- read.csv("D:/Documents/UIBE/6/TimeSeries/file1.csv")
head(x)
```
截取1925年之后的数据`subset`
```{r }
z <- subset(x, year > 1925, select = yield)
head(z)
```
对`yield`序列进行对数变换，并将对数序列和原序列值导出，保存为数据文件`yield.csv`。
```{r }
ln_yield <- log(x$yield)
x_new <- data.frame(x,ln_yield) #新数据框
write.csv(x_new, file = "D:/Documents/UIBE/6/TimeSeries/yield.csv", row.names = F)
```

#### 缺失值插值

R中缺失值用`NA`表示。常用的插值方法：**线性插值**和**样条插值**
```{r message=FALSE}
library(zoo)
a <- 1:7
a[4] <- NA
cat("a: ", a)
```
```{r}
y1 <- na.approx(a)
y2<-na.spline(a)
cat(" ", y1, "\n ", y2)
```

***

# 第二周 时间序列数据的预处理

#### 统计性质

平稳时间序列**自协方差**函数和**自相关**系数只依赖于时间的平移长度而与时间的起止点无关

- **延迟$k$自协方差函数**
$$
\gamma(k) = \gamma(t,t+k),\quad\forall\,k\in\mathbb{N}
$$
- **延迟$k$自相关系数**
$$
\rho_k = \frac{\gamma(t,t+k)}{\sqrt{DX_t\cdot DX_{t+1}}} = \frac{\gamma(k)}{\gamma(0)}
$$
- **估计**均值函数
$$
\hat{\mu} = \bar{x} = \frac{\sum\limits_{i=1}^{n}x_i}{n}
$$
- **估计**延迟$k$自相关系数
$$
\hat{\rho_k} = \frac{\sum\limits_{i=1}^{n-k}(x_i-\bar{x})(x_{i+k}-\bar{x})}{\sum\limits_{i=1}^{n}(x_i-\bar{x})^2},\quad\forall\,0<k<n
$$

#### 时序图与自相关图

##### 时序图
```{r }
yield <- c(15.2,16.9,15.3,14.9,15.7,15.1,16.7)
yield <- ts(yield, start = 1884)
plot(yield, main = "1884-1890年英格兰和威尔士地区小麦平均亩产量", 
     xlab = "年份", ylab="亩产量")
abline(v = c(1885,1889), 
       h = c(15.5,16.5), 
       lty = 2)
```

`plot`各项参数：
```{r message=FALSE, warning=FALSE}
if(FALSE) {
  type = "p"  # 点
         "l"  # 线
         "b"  # 点连线
         "o"  # 线穿过点
         "h"  # 悬垂线
         "s"  # 阶梯线
  pch = 17 # 点的符号
  lty = 2  # 连线的类型
  lwd = 2  # 连线的宽度（默认宽度的2倍）
  col = 1  # col = "black"
  col = 2  # col = "red"
  col = 3  # col = "green"
  col = 4  # col = "blue"
  xlim = c(1886,1890)
  ylim = c(15,16) # 指定坐标轴范围
}
```

##### 自相关图

自相关图是一个平面悬垂线图，横坐标表示延迟期数，纵坐标表示自相关系数，悬垂线表示自相关系数的大小。
```{r }
acf(yield) #虚线为自相关系数 2倍标准差位置
```

#### 平稳性的检验（图检验方法）

- **时序图检验**：始终在一个常数值附近随机波动，而且波动的范围有界、无明显趋势及周期特征。

- **自相关图检验**：平稳序列通常具有短期相关性。该性质用自相关系数来描述就是随着延迟期数的增加，平稳序列的自相关系数会很快地衰减向零。

#### 例2.1 检验1964年-1999年中国纱年产量序列的平稳性
```{r ex2.1, message=FALSE}
library(readr)
sha <- read_csv("timeseries_data/file4.csv")
output <- ts(sha$output, start = 1964)
plot(output, main = "时序图")
```

时序图有递增趋势，非平稳
```{r 2.1acf}
acf(output, lag = 25,
    main = "自相关图")
```

自相关图衰减缓慢，非平稳。



















